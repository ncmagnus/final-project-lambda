---
title: "Vignette for ODTR package"
author: "Lina Montoya and Nina Magnuson"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  library(ODTR), 
  library(SuperLearner),
  library(hitandrun)
)
```

## Description
DTR computes the simple or optimal dynamic treatment rule for data of the form O = (W, A, Y). W represents pretreatment covariates. A is a binary vector indicating whether treatment was received. Y is a vector for the outcome. Using DTR, we can compute the difference in expected outcome under a dynamic treatment rule (simple or optimal) versus expected outcome under a comparison group. This allows us to analyze the efficacy of different treatment regimes on the outcome. 


## Example Using Simulated Data

In order to illustrate the use of DTR, first use the data.simulation function to generate some data of the correct format. Next we must define the relevant variables from this data for reading into odtr and sodtr. The rule, which is an argument for sodtr, can be generated using one of the covariates, as shown below. This rule represents a simple treatment regime, for instance administering treatment based on individual preference. We advise assigning QAW.SL.library as shown below to ensure the correct form, but this is customizable, read sdtr help file on how to make your own.

```{r}
set.seed(37982)
data <- data.simulation(n=1000)
W = data[,grep("W", names(data))]
W_for_g = subset(W, select = c(W1, W2))
A = data$A
a = 0
Y = data$Y
rule = ifelse(data$W2 > 0, 1, 0) #for simple dynamic treatment 
QAW.SL.library = "SL.correct"
head(data)
```
The data generated contains columns for covariates W, treatment A, and outcome Y as described above. 

## Finding Simple Dynamic Treatment Rule

Sdtr will analyze the difference between the above mentioned, simple rule, and the comparison group.

```{r}
resultssimple = sdtr(W = W, W_for_g = W, a = a, A = A, Y = Y, 
                              rule = rule, 
                              QAW.SL.library = QAW.SL.library)
resultssimple
```
The outputted results from sdtr include TMLE_simple, the difference between targeted maximum likelihood estimator under simple dyanmic treatment regime and expected outcome for the comparison group. Additionally, the 95% lower and upper bound for this estimator are outputted. This value indicates that the simple dynamic treatment rule results in higher expected outcome than the comparison group, an argument in favor of the simple rule. 

## Finding Optimal Dynamic Treatment Rule

Next we will find the optimal dynamic treatment rule for this simulated data. 

```{r}
# note V must contain W_for_g
V = subset(W, select = c(W1, W2))
grid.size = 100
risk.type = "empirical"
QAV.SL.library = c("SL.glm", "SL.glmnet", "SL.mean")
resultsODTR = odtr(W = W, A = A, a = a, Y = Y, V = V, W_for_g = W_for_g,
                          QAW.SL.library = QAW.SL.library, 
                          QAV.SL.library = QAV.SL.library,
                          risk.type = risk.type,
                          grid.size = grid.size)
resultsODTR
```
Analysis of results. 
